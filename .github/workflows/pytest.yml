name: Run all test suites

on:
  pull_request:
    branches:
      - '*'

jobs:
  backend-tests:
    name: Backend Tests (Python)
    needs: runtime-core-build
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      # Silence known third-party deprecations to keep CI signal clean
      PYTEST_ADDOPTS: "-W ignore::DeprecationWarning -W ignore::PendingDeprecationWarning -W ignore::UserWarning"
      # Avoid automatic local builds during tests; rely on runtime-core build artifact
      RUNTIME_CORE_NO_BUILD: "1"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"
          cache-dependency-path: "backend/requirements.txt"

      - name: Set up Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Install dev dependencies (including maturin)
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements-dev.txt

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-

      - name: Cache runtime-core target
        uses: actions/cache@v4
        with:
          path: runtime-core/target
          key: ${{ runner.os }}-runtime-core-target-${{ hashFiles('runtime-core/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-runtime-core-target-

      - name: Download runtime-core wheels
        uses: actions/download-artifact@v4
        with:
          name: runtime-core-wheels
          path: runtime-core-wheels

      - name: List downloaded runtime-core wheels
        run: |
          echo "Runtime & pip info:"
          python -V || true
          python -m pip --version || true
          ls -la runtime-core-wheels || true
          if ! find runtime-core-wheels -type f -name "*.whl" -print -quit | grep -q .; then
            echo "No wheel artifact downloaded; failing job."
            exit 1
          fi
          echo "Found wheel(s):"
          find runtime-core-wheels -type f -name "*.whl" -print -exec ls -l {} \;

      - name: Install runtime-core wheel (artifact)
        run: |
          python -m pip install --upgrade pip
          echo "Installing runtime-core wheel from runtime-core-wheels/"
          ls -la runtime-core-wheels/*.whl || true
          set -o pipefail
          pip install runtime-core-wheels/*.whl || (python -m pip debug --verbose || true; exit 1)

      # Removed wasm-orbit and frontend builds to speed up backend test job.
      # Building those artifacts is handled in separate jobs (`frontend-tests`).

      - name: Install backend dependencies
        run: |
          cd backend
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run pytest
        run: |
          cd backend
          python -m pytest tests/ -v

  runtime-core-build:
    name: Runtime-Core Build (maturin)
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"
          cache-dependency-path: "backend/requirements-dev.txt"

      - name: Set up Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Create .venv and install dev dependencies
        run: |
          python -m venv .venv
          .venv/bin/python -m pip install --upgrade pip
          .venv/bin/python -m pip install -r backend/requirements-dev.txt

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-

      - name: Cache runtime-core target
        uses: actions/cache@v4
        with:
          path: runtime-core/target
          key: ${{ runner.os }}-runtime-core-target-${{ hashFiles('runtime-core/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-runtime-core-target-

      - name: Build runtime-core (maturin)
        run: |
          cd runtime-core
          ../.venv/bin/python -m maturin build --release --out dist

      - name: List built wheels
        run: |
          ls -la runtime-core/dist || true
          ls -la runtime-core/target/wheels || true

      - name: Verify wheels exist
        run: |
          if [ -z "$(ls runtime-core/dist/*.whl 2>/dev/null)$(ls runtime-core/target/wheels/*.whl 2>/dev/null)" ]; then
            echo "No wheels found in runtime-core/dist or runtime-core/target/wheels; failing build"
            ls -la runtime-core || true
            exit 1
          fi

      - name: Write last built commit marker
        run: |
          mkdir -p runtime-core/target
          cd runtime-core
          git rev-parse HEAD > target/.last_built_commit
          echo "Wrote marker to runtime-core/target/.last_built_commit"

      - name: Prepare runtime-core-wheels artifact
        run: |
          mkdir -p runtime-core-wheels
          cp runtime-core/dist/*.whl runtime-core/target/wheels/*.whl runtime-core-wheels/ 2>/dev/null || true
          ls -la runtime-core-wheels || true
          if [ -z "$(ls runtime-core-wheels/*.whl 2>/dev/null)" ]; then
            echo "No wheel found for upload; failing build"
            ls -la runtime-core || true
            exit 1
          fi

      - name: Upload runtime-core wheels
        uses: actions/upload-artifact@v4
        with:
          name: runtime-core-wheels
          path: runtime-core-wheels/*.whl

  runtime-core-tests:
    name: Runtime-Core Tests (Rust)
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Run cargo tests
        run: |
          cd runtime-core
          cargo test --lib --release

  wasm-orbit-build:
    name: WASM-Orbit Build (wasm-pack)
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Install wasm-pack
        run: |
          cargo install wasm-pack --locked

      - name: Build wasm-orbit (wasm-pack)
        run: |
          cd wasm-orbit
          wasm-pack build --target web

      - name: Upload wasm-orbit pkg
        uses: actions/upload-artifact@v4
        with:
          name: wasm-orbit-pkg
          path: wasm-orbit/pkg/**

  frontend-tests:
    name: Frontend Tests (TypeScript)
    needs: wasm-orbit-build
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Download wasm-orbit pkg
        uses: actions/download-artifact@v4
        with:
          name: wasm-orbit-pkg
          path: wasm-orbit-pkg

      - name: Copy wasm to frontend
        run: |
          mkdir -p frontend/src/wasm
          cp -r wasm-orbit-pkg/* frontend/src/wasm/

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "frontend/package-lock.json"

      - name: Install dependencies
        run: |
          npm ci  --prefix frontend

      - name: Build frontend
        run: |
          npm run build --prefix frontend

      - name: Run tests
        run: |
          npm test  --prefix frontend

  builds:
    name: Build Artifacts
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: "backend/requirements.txt"

      - name: Set up Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          target: wasm32-unknown-unknown

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "frontend/package-lock.json"

      - name: Install maturin
        run: |
          python -m venv .venv
          . .venv/bin/activate
          python -m pip install --upgrade pip maturin

      - name: Install wasm-pack
        uses: jetli/wasm-pack-action@v0.4.0

      - name: Build runtime-core (maturin)
        run: |
          cd runtime-core
          . ../.venv/bin/activate
          # Explicitly output wheels to dist for consistency with other jobs
          maturin build --release --out dist
          ls -la dist || ls -la target/wheels || true

      - name: Install runtime-core wheel
        run: |
          . .venv/bin/activate
          echo "Looking for built wheels in runtime-core/dist and runtime-core/target/wheels"
          find runtime-core/dist runtime-core/target/wheels -type f -name "*.whl" -print -quit > /tmp/wheelpath || true
          WHEEL=$(cat /tmp/wheelpath || true)
          if [ -z "$WHEEL" ]; then
            echo "No wheel found; listing runtime-core contents for debug:"
            ls -la runtime-core || true
            exit 1
          fi
          echo "Installing wheel: $WHEEL"
          pip install "$WHEEL" || (python -m pip debug --verbose || true; exit 1)

      - name: Install backend dependencies
        run: |
          . .venv/bin/activate
          pip install -r backend/requirements.txt

      - name: Build wasm-orbit bindings
        run: |
          cd wasm-orbit
          wasm-pack build --target web

      - name: Build frontend
        run: |
          npm ci  --prefix frontend
          npm run build  --prefix frontend

      - name: Compile backend
        run: |
          . .venv/bin/activate
          cd backend
          python -m compileall .
